GBO Mapper v. 0.4.2 alpha 3
Дата сборки: 04.02.2020
WWW: http://shimigon.narod.ru/gbomap.html
Copyleft: Шимигон Алексей
Основано на макросе для настройки ГБО 4 поколения:
http://gazmap.ru/stati/regulirovka-gbo-lovato-i-omvl

Работа программы изначально аналогична работе макроса, но расчёт происходит
более автоматизировано и во много раз быстрее. В отличие от оригинала,
файлы данных для расчёта добавляются произвольно, в процессе работы
программа сама разбирает структуру файлов по заголовку, сортирует
записи на бензиновые и газовые. Для работы алгоритма может быть достаточно
одного файла данных, если в нём будут записи движения на бензине и на газе.
Разделитель дробной части может быль любой - и точка и запятая, но программа
чувствительна к наличию в файлах заголовка и его составу.
Если данные МАР в файлах записаны как целое число, то программа автоматически
нормирует их.
Результаты расчётов могут незначительно отличаться от оригинальных макросов,
это связано скорее всего с различными методами округления промежуточных данных
в FreePascal и VisualBasic.

В программе реализовано несколько алгоритмов расчёта:

- по среднему времени впрыска - аналогично оригинальному макросу.
- по среднему значению MAP. Считаются средние значения MAP в каждой точке для
  бензиновых и газовых данных. Далее результаты сравниваются и строится таблица
  корректировок.
- по данным коррекции контроллера двигателя.
- по данным двух контроллеров.

При нажатии на верхнюю левую ячейку карты изменений, открывается меню
экспорта данных - печать в цвете, ч/б (отличие в наличии или отсутствии
цветового фона ячеек таблицы) или экспорт текста для последующей обработки,
например в табличных процессорах.

Расчёт коррекций по данным бензинового контроллера
--------------------------------------------------
Этот метод позволяет полностью отказаться от записи данных газового контроллера,
а использовать только данные контроллера двигателя. Основное условие - наличие
всех необходимых для расчёта данных: обороты двигателя, время впрыска и
топливные коррекции (кратковременная и долговременная). Файл данных записывается
при езде на газе и адаптированном контроллере (до записи нужно некоторое время
не ездить на бензине, а только на газе).
Для расчёта загрузите файл с данными, программа попытается автоматически его
распознать. В случае, если формат файла определён и в нём опознаны столбцы
данных, программа останется во вкладке "Настройки". Если данные не опознаны, то
откроет вкладку "Настройки данных", где можно будет выбрать столбцы данных по
заголовкам вручную. Если формат файла не будет определён - программа выдаст
ошибку "Заголовок не определён".
Для начала расчёта следует во вкладке "Настройки" нажать кнопку "Старт",
предварительно проверив корректность всех точек и дельт.
При расчёте просматриваются все записи, определяются те, которые соответствуют
каждой ячейке (Обороты ± Δ, время впрыска ± Δ), данные коррекций суммируются,
затем результат делится на количество точек и записывается в ячейку таблицы.

Расчёт коррекций по данным двух контроллеров
--------------------------------------------
В версии 0.4.0 реализован метод расчёта таблицы коррекций по данным контроллера
двигателя и газового контроллера. Для расчёта необходимо одновременно записать
данные с газового контроллера и основного контроллера двигателя при езде на
газе. Данные необходимо записывать синхронно. При этом в данных газового
контроллера не принципиально наличие параметра MAP. Этот метод может быть
полезен, если из контроллера двигателя не удаётся получить данные о времени
открытия форсунок. Ездить на бензине для расчёта не нужно.
В начале поездки включаем запись данных с минимальной разницей по времени
(не более 5 секунд), в конце поездки также отключаем, иначе могут возникнуть
проблемы при синхронизации.
Запись данных газового контроллера подробно описывать не буду, а для записи
данных контроллера использовал Torque под Android, подключенный через bluetooth
адаптер ELM-327. В результате получил файл CSV. Нужно включить запись оборотов
двигателя и все параметры Fuel Trim. Период записи ставим 1 секунду. Газовый
контроллер (у всяком случае у меня) пишет намного чаще - около 8 записей в
секунду, но смысла писать с такой скоростью с контроллера двигателя нет, потому
что параметры реально обновляются примерно раз в 2 секунды. Возможно есть более
быстрый и точный способ получения данных с бензинового контроллера. Если ваши
данные не будут открываться в программе - пишите, будем разбираться. Заголовок
обрабатывается по ключевым словам (наличию в тексте подстрок):
RPM - Обороты двигателя
Fuel + Trim + Long - Долговременная коррекция (LTFT)
Fuel + Trim - Кратковременная коррекция (STFT)
В версии 0.4.2 этот перечень значительно расширен.
При невозможности открытия файла в программе или некорректной работе, заголовок
можно подправить вручную. Файлы CSV открываются в электронных таблицах
(MS Excel, OpenOffice.org Calc и т.п.) и в простых текстовых редакторах.
В программе GBOMap в выпадающем списке сверху выбираем метод расчёта по данным
двух контроллеров, при этом список исходных данных меняется на две строки для
файлов данных, ниже появляются дополнительные параметры настройки и пустой
график синхронизации оборотов двигателя.
Нажимаем кнопку "Открыть" и выбираем либо оба файла данных сразу, либо по
отдельности. Файлы сразу обрабатываются по содержимому и добавляются в
соответствующие строки - верхняя для газового контроллера, нижняя - для
контроллера двигателя. В случае если открыть другой файл контроллера, когда он
уже был загружен, то новый не будет загружен. Для загрузки новых данных, нужно
сначала нажать кнопку "Очистить".
После загрузки данных, следует уточнить столбцы LTFT и STFT, так как подобных
записей в файле может быть несколько и не все из них содержат правильные данные.
Обработку данных LTFT (Long Time Fuel Trim) можно отключить, выбрав в списке
"Отключено".
Далее нажимаем "Старт". Программа загрузит данные из обоих файлов и попытается
синхронизировать их по оборотам двигателя, подобрав коэффициенты K и B:
K - вещественное число "усиление" или сколько строк газовых записей приходится
    на одну запись контроллера двигателя.
B - целое число "смещение" или на сколько строк газовых записей следует сместить
    данные бензинового контроллера. Положительное число смещает данные
    контроллера вправо, отрицательное влево.
Автоматический подбор коэффициентов может занять несколько секунд в зависимости
от размеров исходных файлов и скорости компьютера.
Показателем качества синхронизации является средняя разность оборотов двигателя.
Установлен фильтр: если разность оборотов меньше любой из дельт оборотов или
меньше 200, то данные считаются синхронизированными и расчёт идёт дальше.
Если условие не выполняется, то выдаётся сообщение об ошибке "Данные не
синхронизированы!". Синхронизацию данных можно проконтролировать визуально по
графику оборотов. Синий график - данные газового контроллера, красный -
контроллера двигателя. Его можно приближать, выделяя нужные области мышкой.
Коэффициенты можно ввести вручную и заново нажать кнопку "Старт" для проверки.
Если коэффициенты K = 1 и B = 0, то программа будет подбирать их заново, иначе
использует введённые данные.
Если данные синхронизированы, то выполняется построение таблицы изменений.
Программа просматривает данные, выбирает соответствующие каждой ячейке таблицы
(Обороты ± Δ, время впрыска бензина ± Δ), суммирует соответствующие им значения
коррекций из данных контроллера двигателя, делит на количество точек и
записывает результат в соответствующую ячейку таблицы. Если данных для ячейки не
нашлось, в ней ставится прочерк. Если данные LTFT отключены, то суммируются
только данные STFT.

Использование программы полностью бесплатно, без ограничений, на странице
проекта доступны исходники. Написано на Lazarus (FreePascal).

Удачной настройки!

Мои контакты:
shimigon@yandex.ru
vk.com/ashimigon

ИСТОРИЯ ИЗМЕНЕНИЙ
-----------------

0.1.0 - Первый работоспособный выпуск

0.2.0 - Добавлены варианты заголовков INJ. и INJ.BENZ.
        Попытка реализации расчёта через расширенную таблицу.

0.3.0 - Отменён способ расчёта через расширенную таблицу.
        Добавлен расчёт по среднему значению MAP.

0.3.5 - Добавлена форма для заполнения точек времени впрыска.

0.3.6 - Эксперименты с аппроксимацией: вывод графиков зависимости MAP и
        времени впрыска при заданных оборотах.

0.3.7 - Продолжение экспериментов: аппроксимация МНК четырьмя функциями:
        линейной, параболой, экспоненциальной и логарифмической с автоматическим
        выбором лучшей. Зависимость для бензиновых данных перевёрнута -
        впрыск по горизонтали, MAP по вертикали. Сделано для удобства построения
        бензиновой таблицы.

0.3.8 - Построение таблиц и вывод карты изменений по аппроксимированным данным.

0.3.9 - Добавлен расчёт по таблице MAP.

0.4.0 - Добавлен расчёт по данным двух контроллеров.

0.4.1 - Добавлен расчёт по данным контроллера двигателя.
        Исправления алгоритма расчёта по данным двух контроллеров.

0.4.2 - Исключены методы аппроксимации и таблице MAP, как неудачные.
        Переработан алгоритм загрузки файлов, значительно увеличен перечень
        ключевых слов заголовка. Файлы газового контроллера и контроллера
        двигателя загружаются одинаково, а далее тип файла определяется по
        содержимому.
        Изменён метод расчёта по данным контроллера двигателя. Теперь есть
        возможность настроить данные вручную. Ключевое условие для обработки
        файла - текстовый формат и наличие в нём столбцов данных. Разделение
        ячеек - любое (запятая, точка с запятой или табуляция). Доступны
        настройки разделителя вручную и два варианта кодировки - cp1251 и UTF8
        на случай заголовка на русском языке.
        Добавлен расчёт с использованием медианы вместо среднего арифметического